<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Platform Monitor</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background-color: #4caf50;
        }

        .status-error {
            background-color: #f44336;
        }

        .chart-container {
            width: 100%;
            height: 300px;
        }

        h1, h2 {
            margin-top: 0;
            color: #ffffff;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .metric-label {
            color: #888888;
            font-size: 14px;
        }
    </style>
</head>
<body>
<h1>Crypto Trading Platform Monitor</h1>

<div class="dashboard-grid">
    <div class="metric-card">
        <h2>Collection Status</h2>
        <div id="connectionStatus">
            <p>
                <span class="status-indicator" id="websocketStatus"></span>
                Websocket Connection
            </p>
            <p>
                <span class="status-indicator" id="dbStatus"></span>
                Database Connection
            </p>
        </div>
        <div id="statusDetails"></div>
    </div>

    <div class="metric-card">
        <h2>Collection Statistics</h2>
        <div class="metric-label">Trades Collected</div>
        <div class="metric-value" id="tradesCount">0</div>

        <div class="metric-label">Orders Collected</div>
        <div class="metric-value" id="ordersCount">0</div>

        <div class="metric-label">Collection Rate</div>
        <div class="metric-value" id="collectionRate">0/sec</div>

        <div class="metric-label">Last Update</div>
        <div class="metric-value" id="lastUpdate">-</div>
    </div>

    <div class="metric-card">
        <h2>Trade Volume</h2>
        <div id="volumeChart" class="chart-container"></div>
    </div>

    <div class="metric-card">
        <h2>Order Book Depth</h2>
        <div id="depthChart" class="chart-container"></div>
    </div>
</div>

<script>
    let ws = null;
    const reconnectDelay = 1000;

    function connect() {
        ws = new WebSocket('ws://' + window.location.host + '/ws');

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            updateDashboard(data);
        };

        ws.onclose = function() {
            setTimeout(connect, reconnectDelay);
        };
    }

    function updateDashboard(data) {
        // Update status indicators
        document.getElementById('websocketStatus').className =
                'status-indicator status-' + data.status.websocket;
        document.getElementById('dbStatus').className =
                'status-indicator status-' + data.status.database;

        // Update statistics
        document.getElementById('tradesCount').textContent =
                data.stats.trades.toLocaleString();
        document.getElementById('ordersCount').textContent =
                data.stats.orders.toLocaleString();
        document.getElementById('collectionRate').textContent =
                data.stats.rate.toFixed(2) + '/sec';

        // Update charts
        updateVolumeChart(data);
        updateDepthChart(data);

        // Update warnings
        const warnings = data.status.warnings;
        document.getElementById('statusDetails').innerHTML =
                warnings.length ? warnings.join('<br>') : '';
    }

    function updateVolumeChart(data) {
        const trace = {
            x: data.timestamps,
            y: data.volumes,
            type: 'scatter',
            mode: 'lines',
            name: 'Volume',
            line: {color: '#4caf50'}
        };

        const layout = {
            plot_bgcolor: '#2d2d2d',
            paper_bgcolor: '#2d2d2d',
            font: {color: '#ffffff'},
            margin: {t: 10, r: 10, b: 30, l: 40},
            showlegend: false,
            xaxis: {showgrid: true, gridcolor: '#444444'},
            yaxis: {showgrid: true, gridcolor: '#444444'}
        };

        Plotly.newPlot('volumeChart', [trace], layout);
    }

    function updateDepthChart(data) {
        const bidTrace = {
            x: data.timestamps,
            y: data.bidDepth,
            type: 'scatter',
            mode: 'lines',
            name: 'Bid Depth',
            line: {color: '#4caf50'}
        };

        const askTrace = {
            x: data.timestamps,
            y: data.askDepth,
            type: 'scatter',
            mode: 'lines',
            name: 'Ask Depth',
            line: {color: '#f44336'}
        };

        const layout = {
            plot_bgcolor: '#2d2d2d',
            paper_bgcolor: '#2d2d2d',
            font: {color: '#ffffff'},
            margin: {t: 10, r: 10, b: 30, l: 40},
            showlegend: true,
            legend: {
                x: 0,
                y: 1,
                bgcolor: '#2d2d2d',
                font: {color: '#ffffff'}
            },
            xaxis: {showgrid: true, gridcolor: '#444444'},
            yaxis: {showgrid: true, gridcolor: '#444444'}
        };

        Plotly.newPlot('depthChart', [bidTrace, askTrace], layout);
    }
    connect();

    // Initial data fetch
    fetch('/api/collector/stats')
            .then(response => response.json())
            .then(data => updateDashboard(data))
            .catch(error => console.error('Error fetching initial data:', error));
    // Start WebSocket connection
    connect();

    // Initial data fetch
    fetch('/api/collector/stats')
            .then(response => response.json())
            .then(data => updateDashboard(data))
            .catch(error => console.error('Error fetching initial data:', error));
</script>
</body>
</html>